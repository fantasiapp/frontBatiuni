{"ast":null,"code":"import { EventEmitter, TemplateRef, ViewContainerRef } from \"@angular/core\";\nimport { Subject } from \"rxjs\";\nimport { map, switchMap, take, takeUntil } from \"rxjs/operators\";\nimport { DimensionMenu } from \"src/app/shared/common/classes\";\nimport { DataQueries, DataState } from \"src/models/new/data.state\";\nimport { FileViewer } from \"../file-viewer/file-viewer.component\";\nimport { SignContract } from \"src/models/new/user/user.actions\";\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@ngxs/store\";\nimport * as i2 from \"../file-viewer/file-viewer.component\";\nimport * as i3 from \"@angular/common\";\nimport * as i4 from \"../../services/file-downloader.service\";\nconst _c0 = [\"view\"];\nconst _c1 = [\"delete\"];\nconst _c2 = [\"sign\"];\n\nfunction UIPopup_ng_template_6_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r7 = i0.ɵɵgetCurrentView();\n\n    i0.ɵɵtext(0, \" Voudriez-vous supprimer l'annonce ? \");\n    i0.ɵɵelement(1, \"hr\", 6);\n    i0.ɵɵelementStart(2, \"div\", 7);\n    i0.ɵɵelementStart(3, \"button\", 8);\n    i0.ɵɵlistener(\"click\", function UIPopup_ng_template_6_Template_button_click_3_listener() {\n      const restoredCtx = i0.ɵɵrestoreView(_r7);\n      const output_r5 = restoredCtx.$implicit;\n      return output_r5 && output_r5.next(true);\n    });\n    i0.ɵɵtext(4, \"Confirmer\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(5, \"button\", 9);\n    i0.ɵɵlistener(\"click\", function UIPopup_ng_template_6_Template_button_click_5_listener() {\n      const restoredCtx = i0.ɵɵrestoreView(_r7);\n      const output_r5 = restoredCtx.$implicit;\n      return output_r5 && output_r5.next(false);\n    });\n    i0.ɵɵtext(6, \"Annuler\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementEnd();\n  }\n}\n\nfunction UIPopup_ng_template_8_button_1_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r13 = i0.ɵɵgetCurrentView();\n\n    i0.ɵɵelementStart(0, \"button\", 8);\n    i0.ɵɵlistener(\"click\", function UIPopup_ng_template_8_button_1_Template_button_click_0_listener() {\n      i0.ɵɵrestoreView(_r13);\n      const signature_r9 = i0.ɵɵnextContext().$implicit;\n      const ctx_r11 = i0.ɵɵnextContext();\n      return ctx_r11.actionSign(signature_r9.missionId, signature_r9.view);\n    });\n    i0.ɵɵtext(1, \"Signer\");\n    i0.ɵɵelementEnd();\n  }\n}\n\nfunction UIPopup_ng_template_8_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelement(0, \"file-viewer\", 10);\n    i0.ɵɵtemplate(1, UIPopup_ng_template_8_button_1_Template, 2, 0, \"button\", 11);\n  }\n\n  if (rf & 2) {\n    const signature_r9 = ctx.$implicit;\n    i0.ɵɵproperty(\"fileContext\", signature_r9.fileContext);\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"ngIf\", !signature_r9.signedByProfile);\n  }\n}\n\nconst _c3 = [\"*\"];\nconst TRANSITION_DURATION = 200; //extend to support components\n\nexport let UIPopup = /*#__PURE__*/(() => {\n  class UIPopup extends DimensionMenu {\n    constructor(cd, componentFactoryResolver, popupService, store) {\n      super();\n      this.cd = cd;\n      this.componentFactoryResolver = componentFactoryResolver;\n      this.popupService = popupService;\n      this.store = store;\n      this.fromService = false;\n      this.keepAlive = true;\n      this.willClose = false; //extends destroy, no multiple inheritance :(\n\n      this.destroy$ = new Subject();\n    }\n\n    ngOnInit() {\n      if (!this.fromService) return;\n      this.popupService.popups$.pipe(takeUntil(this.destroy$)).subscribe(view => {\n        var _a, _b;\n\n        if (!view) return this.close();\n        if (!this.view) return; //ignore\n\n        this.view.clear();\n\n        if (view.type == 'predefined' || view.type == 'template') {\n          this.content = view;\n          const template = view.type == 'predefined' ? this[view.name] : view.template,\n                context = view.context;\n          this.view.createEmbeddedView(template, context);\n        } else if (view.type == 'component') {\n          this.content = view;\n          const factory = this.componentFactoryResolver.resolveComponentFactory(this.content.component),\n                componentRef = this.view.createComponent(factory);\n          if (this.content.init) this.content.init(componentRef.instance);\n        } else if (view.type == 'context') {\n          if (((_a = this.content) === null || _a === void 0 ? void 0 : _a.type) == 'template' || ((_b = this.content) === null || _b === void 0 ? void 0 : _b.type) == 'predefined') {\n            const template = this.content.type == 'predefined' ? this[this.content.name] : this.content.template;\n            this.content.context = view.context;\n            this.view.createEmbeddedView(template, this.content.context);\n          }\n        }\n\n        this.open = true;\n        this.cd.markForCheck();\n      });\n      this.popupService.dimension$.pipe(takeUntil(this.destroy$)).subscribe(dimension => {\n        this.dimension = dimension;\n        this.cd.markForCheck();\n      });\n    }\n\n    close() {\n      this.willClose = true;\n      setTimeout(() => {\n        var _a;\n\n        if (!this.keepAlive) this.view.clear();\n        this.willClose = false;\n        this.openChange.emit(this._open = false);\n\n        if ((_a = this.content) === null || _a === void 0 ? void 0 : _a.close) {\n          this.content.close();\n        }\n\n        this.cd.markForCheck();\n      }, TRANSITION_DURATION);\n    }\n\n    ngOnDestroy() {\n      this.destroy$.next();\n      this.destroy$.complete();\n    }\n\n    actionSign(missionId, view) {\n      //signe le contrat ici\n      console.log('signing contract', missionId, view);\n      this.store.dispatch(new SignContract(missionId, view)).pipe(take(1)).subscribe(() => {// this.close();\n      });\n    }\n\n    openWindow(url) {\n      window.open(url);\n    }\n\n  }\n\n  UIPopup.ɵfac = function UIPopup_Factory(t) {\n    return new (t || UIPopup)(i0.ɵɵdirectiveInject(i0.ChangeDetectorRef), i0.ɵɵdirectiveInject(i0.ComponentFactoryResolver), i0.ɵɵdirectiveInject(PopupService), i0.ɵɵdirectiveInject(i1.Store));\n  };\n\n  UIPopup.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n    type: UIPopup,\n    selectors: [[\"popup\"]],\n    viewQuery: function UIPopup_Query(rf, ctx) {\n      if (rf & 1) {\n        i0.ɵɵviewQuery(_c0, 7, ViewContainerRef);\n        i0.ɵɵviewQuery(_c1, 7, TemplateRef);\n        i0.ɵɵviewQuery(_c2, 7, TemplateRef);\n      }\n\n      if (rf & 2) {\n        let _t;\n\n        i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.view = _t.first);\n        i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.deletePost = _t.first);\n        i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.sign = _t.first);\n      }\n    },\n    inputs: {\n      content: \"content\",\n      fromService: \"fromService\",\n      keepAlive: \"keepAlive\"\n    },\n    features: [i0.ɵɵInheritDefinitionFeature],\n    ngContentSelectors: _c3,\n    decls: 10,\n    vars: 4,\n    consts: [[1, \"cover\"], [1, \"menu\", \"cover-parent\", \"hosted-page\", \"flex\", \"column\", \"center\", \"space-children-margin\", \"center-text\"], [\"src\", \"assets/X.svg\", 1, \"position-absolute\", \"close-button\", 3, \"click\"], [\"view\", \"\"], [\"delete\", \"\"], [\"sign\", \"\"], [1, \"dashed\", 2, \"margin-left\", \"0 !important\"], [1, \"controls\", \"full-width\", \"flex\", \"space-around\"], [1, \"button\", \"active\", 3, \"click\"], [1, \"button\", \"passive\", 3, \"click\"], [1, \"grow\", 3, \"fileContext\"], [\"class\", \"button active\", 3, \"click\", 4, \"ngIf\"]],\n    template: function UIPopup_Template(rf, ctx) {\n      if (rf & 1) {\n        i0.ɵɵprojectionDef();\n        i0.ɵɵelement(0, \"div\", 0);\n        i0.ɵɵelementStart(1, \"div\", 1);\n        i0.ɵɵelementStart(2, \"img\", 2);\n        i0.ɵɵlistener(\"click\", function UIPopup_Template_img_click_2_listener() {\n          return ctx.close();\n        });\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementContainerStart(3, null, 3);\n        i0.ɵɵprojection(5);\n        i0.ɵɵelementContainerEnd();\n        i0.ɵɵelementEnd();\n        i0.ɵɵtemplate(6, UIPopup_ng_template_6_Template, 7, 0, \"ng-template\", null, 4, i0.ɵɵtemplateRefExtractor);\n        i0.ɵɵtemplate(8, UIPopup_ng_template_8_Template, 2, 2, \"ng-template\", null, 5, i0.ɵɵtemplateRefExtractor);\n      }\n\n      if (rf & 2) {\n        i0.ɵɵclassProp(\"open\", ctx.open && !ctx.willClose);\n        i0.ɵɵadvance(1);\n        i0.ɵɵclassProp(\"open\", ctx.open && !ctx.willClose);\n      }\n    },\n    directives: [i2.FileViewer, i3.NgIf],\n    styles: [\"[_ngcontent-%COMP%]:root{--notification-size: $notification-size}.page-content-with-tabs[_ngcontent-%COMP%]{width:100%;overflow-y:auto;overflow-x:hidden;touch-action:pan-y!important}.page-content-with-tabs[_ngcontent-%COMP%]{margin-top:150px;margin-top:calc(constant(safe-area-inset-top) + 150px);margin-top:calc(env(safe-area-inset-top) + 150px);margin-bottom:0;margin-bottom:calc(constant(safe-area-inset-bottom) + 0);margin-bottom:calc(env(safe-area-inset-bottom) + 0);height:calc(100vh - 220px - env(safe-area-inset-bottom))}.invert[_ngcontent-%COMP%]{filter:invert(1)}[_nghost-%COMP%]{position:absolute;z-index:-1000;width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#000;font-family:\\\"Poppins\\\";overflow:hidden auto;visibility:hidden}.open[_nghost-%COMP%]{visibility:visible;z-index:1000}.cover[_ngcontent-%COMP%]{z-index:-1;position:fixed;width:100vw;left:0;height:100vh;top:0;background-color:#ccc;opacity:0;transition:opacity .2s ease-out 0s}.cover.open[_ngcontent-%COMP%]{opacity:.5}.menu[_ngcontent-%COMP%]{box-shadow:0 3px 6px #aaa;opacity:0;transition:opacity .2s ease-out 0s;border-radius:5px;height:100%}.menu.open[_ngcontent-%COMP%]{opacity:1}.close-button[_ngcontent-%COMP%]{right:15px;top:15px}.date[_ngcontent-%COMP%] {color:#0d6191}\"],\n    changeDetection: 0\n  });\n  return UIPopup;\n})();\n;\nexport let PopupService = /*#__PURE__*/(() => {\n  class PopupService {\n    constructor(store, downloader) {\n      this.store = store;\n      this.downloader = downloader;\n      this.popups$ = new Subject();\n      this.dimension$ = new Subject();\n      this.defaultDimension = {\n        left: '20px',\n        top: '30px',\n        width: 'calc(100% - 40px)',\n        height: 'calc(100% - 60px)'\n      };\n    }\n\n    show(view, dimension) {\n      this.popups$.next(view);\n      this.dimension$.next(Object.assign(Object.assign({}, this.defaultDimension), dimension || {}));\n    }\n\n    openFile(file) {\n      if (!file.content) {\n        this.downloader.downloadFile(file.id, true).subscribe(file => this.openFile(file));\n        return;\n      }\n\n      let context = this.downloader.createFileContext(file);\n      this.popups$.next({\n        type: 'component',\n        component: FileViewer,\n        init: viewer => {\n          viewer.fileContext = context;\n        },\n        close: () => {\n          this.downloader.clearContext(context);\n        }\n      });\n      this.dimension$.next(this.defaultDimension);\n      return true;\n    }\n\n    openDeletePostDialog(source) {\n      this.popups$.next({\n        type: 'predefined',\n        name: 'deletePost',\n        context: {\n          $implicit: source\n        }\n      });\n      source === null || source === void 0 ? void 0 : source.subscribe(console.log);\n      this.dimension$.next({\n        width: '100%',\n        height: '200px',\n        top: 'calc(50% - 100px)',\n        left: '0'\n      });\n      return new EventEmitter();\n    }\n\n    openSignContractDialog(mission) {\n      const view = this.store.selectSnapshot(DataState.view),\n            closed$ = new Subject();\n      let fileContext, previousFileContext;\n      let first = true;\n      this.store.select(DataQueries.getById('Mission', mission.id)).pipe(switchMap(mission => {\n        return this.downloader.downloadFile(mission.contract).pipe(map(file => ({\n          mission,\n          file\n        })));\n      }), takeUntil(closed$)).subscribe(({\n        mission,\n        file\n      }) => {\n        fileContext = this.downloader.createFileContext(file);\n        const context = {\n          $implicit: {\n            fileContext: fileContext,\n            signedByProfile: mission.signedByCompany && view == 'PME' || mission.signedBySubContractor && view == 'ST',\n            missionId: mission.id,\n            view: view\n          }\n        };\n\n        if (first) {\n          this.dimension$.next(this.defaultDimension);\n          this.popups$.next({\n            type: 'predefined',\n            name: 'sign',\n            context,\n            close: () => {\n              this.downloader.clearContext(fileContext);\n              closed$.next();\n            }\n          });\n          first = false;\n        } else {\n          if (previousFileContext) this.downloader.clearContext(previousFileContext);\n          this.updateTemplate(context);\n        }\n\n        previousFileContext = fileContext;\n      });\n    }\n\n    hide() {\n      this.popups$.next(undefined);\n    }\n\n    updateTemplate(context) {\n      this.popups$.next({\n        type: 'context',\n        context\n      });\n    }\n\n  }\n\n  PopupService.ɵfac = function PopupService_Factory(t) {\n    return new (t || PopupService)(i0.ɵɵinject(i1.Store), i0.ɵɵinject(i4.FileDownloader));\n  };\n\n  PopupService.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n    token: PopupService,\n    factory: PopupService.ɵfac,\n    providedIn: 'root'\n  });\n  return PopupService;\n})();\n;","map":null,"metadata":{},"sourceType":"module"}