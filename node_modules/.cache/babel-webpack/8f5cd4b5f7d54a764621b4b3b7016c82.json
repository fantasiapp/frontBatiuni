{"ast":null,"code":"import { EventEmitter, TemplateRef, ViewContainerRef } from \"@angular/core\";\nimport { Subject } from \"rxjs\";\nimport { map, switchMap, take, takeUntil } from \"rxjs/operators\";\nimport { DimensionMenu } from \"src/app/shared/common/classes\";\nimport { DataQueries, DataState } from \"src/models/new/data.state\";\nimport { FileViewer } from \"../file-viewer/file-viewer.component\";\nimport { SignContract, ModifyDetailedPost } from \"src/models/new/user/user.actions\";\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@ngxs/store\";\nimport * as i2 from \"../file-viewer/file-viewer.component\";\nimport * as i3 from \"@angular/common\";\nimport * as i4 from \"../box/checkbox.component\";\nimport * as i5 from \"../../services/file-downloader.service\";\nconst _c0 = [\"view\"];\nconst _c1 = [\"delete\"];\nconst _c2 = [\"sign\"];\nconst _c3 = [\"setDate\"];\nconst _c4 = [\"closeMission\"];\n\nfunction UIPopup_ng_template_6_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r11 = i0.ɵɵgetCurrentView();\n\n    i0.ɵɵtext(0, \" Voudriez-vous supprimer l'annonce ? \");\n    i0.ɵɵelement(1, \"hr\", 8);\n    i0.ɵɵelementStart(2, \"div\", 9);\n    i0.ɵɵelementStart(3, \"button\", 10);\n    i0.ɵɵlistener(\"click\", function UIPopup_ng_template_6_Template_button_click_3_listener() {\n      const restoredCtx = i0.ɵɵrestoreView(_r11);\n      const output_r9 = restoredCtx.$implicit;\n      return output_r9 && output_r9.next(true);\n    });\n    i0.ɵɵtext(4, \"Confirmer\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(5, \"button\", 11);\n    i0.ɵɵlistener(\"click\", function UIPopup_ng_template_6_Template_button_click_5_listener() {\n      const restoredCtx = i0.ɵɵrestoreView(_r11);\n      const output_r9 = restoredCtx.$implicit;\n      return output_r9 && output_r9.next(false);\n    });\n    i0.ɵɵtext(6, \"Annuler\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementEnd();\n  }\n}\n\nfunction UIPopup_ng_template_8_button_1_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r17 = i0.ɵɵgetCurrentView();\n\n    i0.ɵɵelementStart(0, \"button\", 10);\n    i0.ɵɵlistener(\"click\", function UIPopup_ng_template_8_button_1_Template_button_click_0_listener() {\n      i0.ɵɵrestoreView(_r17);\n      const signature_r13 = i0.ɵɵnextContext().$implicit;\n      const ctx_r15 = i0.ɵɵnextContext();\n      return ctx_r15.actionSign(signature_r13.missionId, signature_r13.view);\n    });\n    i0.ɵɵtext(1, \"Signer\");\n    i0.ɵɵelementEnd();\n  }\n}\n\nfunction UIPopup_ng_template_8_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelement(0, \"file-viewer\", 12);\n    i0.ɵɵtemplate(1, UIPopup_ng_template_8_button_1_Template, 2, 0, \"button\", 13);\n  }\n\n  if (rf & 2) {\n    const signature_r13 = ctx.$implicit;\n    i0.ɵɵproperty(\"fileContext\", signature_r13.fileContext);\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"ngIf\", !signature_r13.signedByProfile);\n  }\n}\n\nfunction UIPopup_ng_template_10_li_8_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r22 = i0.ɵɵgetCurrentView();\n\n    i0.ɵɵelementStart(0, \"li\", 21);\n    i0.ɵɵelementStart(1, \"span\", 22);\n    i0.ɵɵtext(2);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(3, \"checkbox\", 23);\n    i0.ɵɵlistener(\"click\", function UIPopup_ng_template_10_li_8_Template_checkbox_click_3_listener() {\n      const restoredCtx = i0.ɵɵrestoreView(_r22);\n      const task_r20 = restoredCtx.$implicit;\n      const assignDate_r18 = i0.ɵɵnextContext().$implicit;\n      const ctx_r21 = i0.ɵɵnextContext();\n      return ctx_r21.modifyDetailedPostDate(task_r20, assignDate_r18.date);\n    });\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementEnd();\n  }\n\n  if (rf & 2) {\n    const task_r20 = ctx.$implicit;\n    const assignDate_r18 = i0.ɵɵnextContext().$implicit;\n    i0.ɵɵadvance(2);\n    i0.ɵɵtextInterpolate(task_r20.content);\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"value\", task_r20.date == assignDate_r18.date.value);\n  }\n}\n\nfunction UIPopup_ng_template_10_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r26 = i0.ɵɵgetCurrentView();\n\n    i0.ɵɵelementStart(0, \"div\", 14);\n    i0.ɵɵelement(1, \"div\", 15);\n    i0.ɵɵelementStart(2, \"h3\", 16);\n    i0.ɵɵtext(3);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelement(4, \"div\", 15);\n    i0.ɵɵelementStart(5, \"label\", 17);\n    i0.ɵɵtext(6, \"Choisissez les t\\u00E2ches du jour\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(7, \"ul\", 18);\n    i0.ɵɵtemplate(8, UIPopup_ng_template_10_li_8_Template, 4, 2, \"li\", 19);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(9, \"input\", 20);\n    i0.ɵɵlistener(\"focusout\", function UIPopup_ng_template_10_Template_input_focusout_9_listener() {\n      const restoredCtx = i0.ɵɵrestoreView(_r26);\n      const assignDate_r18 = restoredCtx.$implicit;\n      const ctx_r25 = i0.ɵɵnextContext();\n      return ctx_r25.addNewTask(assignDate_r18.missionId, assignDate_r18.date.value);\n    });\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementEnd();\n  }\n\n  if (rf & 2) {\n    const assignDate_r18 = ctx.$implicit;\n    i0.ɵɵadvance(3);\n    i0.ɵɵtextInterpolate1(\"Le \", assignDate_r18.date.value, \"\");\n    i0.ɵɵadvance(5);\n    i0.ɵɵproperty(\"ngForOf\", assignDate_r18.date.taskWithoutDouble);\n  }\n}\n\nfunction UIPopup_ng_template_12_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"label\");\n    i0.ɵɵtext(1, \"Noter l'entreprise\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(2, \"label\");\n    i0.ɵɵtext(3);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(4, \"label\");\n    i0.ɵɵtext(5, \"Confirmer-vous la cl\\u00F4ture de cette mission ?\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelement(6, \"div\", 15);\n    i0.ɵɵelementStart(7, \"div\", 9);\n    i0.ɵɵelementStart(8, \"button\", 24);\n    i0.ɵɵtext(9, \"Confirmer\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(10, \"button\", 25);\n    i0.ɵɵtext(11, \"Annuler\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementEnd();\n  }\n\n  if (rf & 2) {\n    const company_r27 = ctx.$implicit;\n    i0.ɵɵadvance(3);\n    i0.ɵɵtextInterpolate1(\" \", company_r27.name, \"\");\n  }\n}\n\nconst _c5 = [\"*\"];\nconst TRANSITION_DURATION = 200; //extend to support components\n\nexport let UIPopup = /*#__PURE__*/(() => {\n  class UIPopup extends DimensionMenu {\n    constructor(cd, componentFactoryResolver, popupService, store) {\n      super();\n      this.cd = cd;\n      this.componentFactoryResolver = componentFactoryResolver;\n      this.popupService = popupService;\n      this.store = store;\n      this.fromService = false;\n      this.keepAlive = true;\n      this.willClose = false; //extends destroy, no multiple inheritance :(\n\n      this.destroy$ = new Subject();\n    }\n\n    ngOnInit() {\n      if (!this.fromService) return;\n      this.popupService.popups$.pipe(takeUntil(this.destroy$)).subscribe(view => {\n        var _a, _b;\n\n        if (!view) return this.close();\n        if (!this.view) return; //ignore\n\n        this.view.clear();\n\n        if (view.type == 'predefined' || view.type == 'template') {\n          this.content = view;\n          const template = view.type == 'predefined' ? this[view.name] : view.template,\n                context = view.context;\n          this.view.createEmbeddedView(template, context);\n        } else if (view.type == 'component') {\n          this.content = view;\n          const factory = this.componentFactoryResolver.resolveComponentFactory(this.content.component),\n                componentRef = this.view.createComponent(factory);\n          if (this.content.init) this.content.init(componentRef.instance);\n        } else if (view.type == 'context') {\n          if (((_a = this.content) === null || _a === void 0 ? void 0 : _a.type) == 'template' || ((_b = this.content) === null || _b === void 0 ? void 0 : _b.type) == 'predefined') {\n            const template = this.content.type == 'predefined' ? this[this.content.name] : this.content.template;\n            this.content.context = view.context;\n            this.view.createEmbeddedView(template, this.content.context);\n          }\n        }\n\n        this.open = true;\n        this.cd.markForCheck();\n      });\n      this.popupService.dimension$.pipe(takeUntil(this.destroy$)).subscribe(dimension => {\n        this.dimension = dimension;\n        this.cd.markForCheck();\n      });\n    }\n\n    close() {\n      this.willClose = true;\n      setTimeout(() => {\n        var _a;\n\n        if (!this.keepAlive) this.view.clear();\n        this.willClose = false;\n        this.openChange.emit(this._open = false);\n\n        if ((_a = this.content) === null || _a === void 0 ? void 0 : _a.close) {\n          this.content.close();\n        }\n\n        this.cd.markForCheck();\n      }, TRANSITION_DURATION);\n    }\n\n    ngOnDestroy() {\n      this.destroy$.next();\n      this.destroy$.complete();\n    }\n\n    actionSign(missionId, view) {\n      //signe le contrat ici\n      this.store.dispatch(new SignContract(missionId, view)).pipe(take(1)).subscribe(() => {});\n    }\n\n    addNewTask(missionId, date) {}\n\n    modifyDetailedPostDate(task, date) {\n      console.log(\"modifyDetailedPostDate\");\n      task.date = date.value;\n      this.store.dispatch(new ModifyDetailedPost(task)).pipe(take(1)).subscribe(() => {});\n    }\n\n    openWindow(url) {\n      window.open(url);\n    }\n\n  }\n\n  UIPopup.ɵfac = function UIPopup_Factory(t) {\n    return new (t || UIPopup)(i0.ɵɵdirectiveInject(i0.ChangeDetectorRef), i0.ɵɵdirectiveInject(i0.ComponentFactoryResolver), i0.ɵɵdirectiveInject(PopupService), i0.ɵɵdirectiveInject(i1.Store));\n  };\n\n  UIPopup.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n    type: UIPopup,\n    selectors: [[\"popup\"]],\n    viewQuery: function UIPopup_Query(rf, ctx) {\n      if (rf & 1) {\n        i0.ɵɵviewQuery(_c0, 7, ViewContainerRef);\n        i0.ɵɵviewQuery(_c1, 7, TemplateRef);\n        i0.ɵɵviewQuery(_c2, 7, TemplateRef);\n        i0.ɵɵviewQuery(_c3, 7, TemplateRef);\n        i0.ɵɵviewQuery(_c4, 7, TemplateRef);\n      }\n\n      if (rf & 2) {\n        let _t;\n\n        i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.view = _t.first);\n        i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.deletePost = _t.first);\n        i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.sign = _t.first);\n        i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.setDate = _t.first);\n        i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.closeMission = _t.first);\n      }\n    },\n    inputs: {\n      content: \"content\",\n      fromService: \"fromService\",\n      keepAlive: \"keepAlive\"\n    },\n    features: [i0.ɵɵInheritDefinitionFeature],\n    ngContentSelectors: _c5,\n    decls: 14,\n    vars: 4,\n    consts: [[1, \"cover\"], [1, \"menu\", \"cover-parent\", \"hosted-page\", \"flex\", \"column\", \"center\", \"space-children-margin\", \"center-text\"], [\"src\", \"assets/X.svg\", 1, \"position-absolute\", \"close-button\", 3, \"click\"], [\"view\", \"\"], [\"delete\", \"\"], [\"sign\", \"\"], [\"setDate\", \"\"], [\"closeMission\", \"\"], [1, \"dashed\", 2, \"margin-left\", \"0 !important\"], [1, \"controls\", \"full-width\", \"flex\", \"space-around\"], [1, \"button\", \"active\", 3, \"click\"], [1, \"button\", \"passive\", 3, \"click\"], [1, \"grow\", 3, \"fileContext\"], [\"class\", \"button active\", 3, \"click\", 4, \"ngIf\"], [1, \"mainDate\", \"form-input\"], [2, \"height\", \"5%\"], [1, \"titleDate\"], [1, \"subtitleDate\"], [\"id\", \"listDate\"], [\"class\", \"liDate\", 4, \"ngFor\", \"ngForOf\"], [\"id\", \"addTask\", \"type\", \"text\", \"placeholder\", \"Ajouter une nouvelle t\\u00E2che\", 3, \"focusout\"], [1, \"liDate\"], [1, \"setDateTask\"], [3, \"value\", \"click\"], [1, \"button\", \"active\"], [1, \"button\", \"passive\"]],\n    template: function UIPopup_Template(rf, ctx) {\n      if (rf & 1) {\n        i0.ɵɵprojectionDef();\n        i0.ɵɵelement(0, \"div\", 0);\n        i0.ɵɵelementStart(1, \"div\", 1);\n        i0.ɵɵelementStart(2, \"img\", 2);\n        i0.ɵɵlistener(\"click\", function UIPopup_Template_img_click_2_listener() {\n          return ctx.close();\n        });\n        i0.ɵɵelementEnd();\n        i0.ɵɵelementContainerStart(3, null, 3);\n        i0.ɵɵprojection(5);\n        i0.ɵɵelementContainerEnd();\n        i0.ɵɵelementEnd();\n        i0.ɵɵtemplate(6, UIPopup_ng_template_6_Template, 7, 0, \"ng-template\", null, 4, i0.ɵɵtemplateRefExtractor);\n        i0.ɵɵtemplate(8, UIPopup_ng_template_8_Template, 2, 2, \"ng-template\", null, 5, i0.ɵɵtemplateRefExtractor);\n        i0.ɵɵtemplate(10, UIPopup_ng_template_10_Template, 10, 2, \"ng-template\", null, 6, i0.ɵɵtemplateRefExtractor);\n        i0.ɵɵtemplate(12, UIPopup_ng_template_12_Template, 12, 1, \"ng-template\", null, 7, i0.ɵɵtemplateRefExtractor);\n      }\n\n      if (rf & 2) {\n        i0.ɵɵclassProp(\"open\", ctx.open && !ctx.willClose);\n        i0.ɵɵadvance(1);\n        i0.ɵɵclassProp(\"open\", ctx.open && !ctx.willClose);\n      }\n    },\n    directives: [i2.FileViewer, i3.NgIf, i3.NgForOf, i4.UICheckboxComponent],\n    styles: [\"[_ngcontent-%COMP%]:root{--notification-size: $notification-size}.page-content-with-tabs[_ngcontent-%COMP%]{width:100%;overflow-y:auto;overflow-x:hidden;touch-action:pan-y!important}.page-content-with-tabs[_ngcontent-%COMP%]{margin-top:150px;margin-top:calc(constant(safe-area-inset-top) + 150px);margin-top:calc(env(safe-area-inset-top) + 150px);margin-bottom:0;margin-bottom:calc(constant(safe-area-inset-bottom) + 0);margin-bottom:calc(env(safe-area-inset-bottom) + 0);height:calc(100vh - 220px - env(safe-area-inset-bottom))}.invert[_ngcontent-%COMP%]{filter:invert(1)}[_nghost-%COMP%]{position:absolute;z-index:-1000;width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#000;font-family:\\\"Poppins\\\";overflow:hidden auto;visibility:hidden}.open[_nghost-%COMP%]{visibility:visible;z-index:1000}.cover[_ngcontent-%COMP%]{z-index:-1;position:fixed;width:100vw;left:0;height:100vh;top:0;background-color:#ccc;opacity:0;transition:opacity .2s ease-out 0s}.cover.open[_ngcontent-%COMP%]{opacity:.5}.menu[_ngcontent-%COMP%]{box-shadow:0 3px 6px #aaa;opacity:0;transition:opacity .2s ease-out 0s;border-radius:5px;height:100%}.menu.open[_ngcontent-%COMP%]{opacity:1}.close-button[_ngcontent-%COMP%]{right:15px;top:15px}.date[_ngcontent-%COMP%] {color:#0d6191}.mainDate[_ngcontent-%COMP%]{display:flex;flex-direction:column;width:100%;height:100%}.titleDate[_ngcontent-%COMP%]{width:80%;height:50px;width:90%;color:#0d6191;margin:20px;text-align:left}.subtitleDate[_ngcontent-%COMP%]{text-align:left;margin:20px}#listDate[_ngcontent-%COMP%]{width:95%;padding-left:2.5%;box-shadow:0 3px 6px #00000029;max-height:80%;overflow-y:scroll}.liDate[_ngcontent-%COMP%]{display:flex;flex-direction:row;justify-content:space-between;padding-left:5%;width:90%;padding-bottom:5%}#addTask[_ngcontent-%COMP%]{width:90%;margin-left:5%;margin-top:20px}.setDateTask[_ngcontent-%COMP%]{text-align:left;width:90%}\"],\n    changeDetection: 0\n  });\n  return UIPopup;\n})();\n;\nexport let PopupService = /*#__PURE__*/(() => {\n  class PopupService {\n    constructor(store, downloader) {\n      this.store = store;\n      this.downloader = downloader;\n      this.popups$ = new Subject();\n      this.dimension$ = new Subject();\n      this.defaultDimension = {\n        left: '20px',\n        top: '30px',\n        width: 'calc(100% - 40px)',\n        height: 'calc(100% - 60px)'\n      };\n    }\n\n    show(view, dimension) {\n      this.popups$.next(view);\n      this.dimension$.next(Object.assign(Object.assign({}, this.defaultDimension), dimension || {}));\n    }\n\n    openFile(file) {\n      console.log(\"openFile\", file);\n\n      if (!file.content) {\n        this.downloader.downloadFile(file.id, true).subscribe(file => this.openFile(file));\n        return;\n      }\n\n      let context = this.downloader.createFileContext(file);\n      this.popups$.next({\n        type: 'component',\n        component: FileViewer,\n        init: viewer => {\n          viewer.fileContext = context;\n        },\n        close: () => {\n          this.downloader.clearContext(context);\n        }\n      });\n      this.dimension$.next(this.defaultDimension);\n      return true;\n    }\n\n    openDeletePostDialog(source) {\n      this.popups$.next({\n        type: 'predefined',\n        name: 'deletePost',\n        context: {\n          $implicit: source\n        }\n      });\n      this.dimension$.next({\n        width: '100%',\n        height: '200px',\n        top: 'calc(50% - 100px)',\n        left: '0'\n      });\n      return new EventEmitter();\n    }\n\n    openSignContractDialog(mission) {\n      const view = this.store.selectSnapshot(DataState.view),\n            closed$ = new Subject();\n      let fileContext, previousFileContext;\n      let first = true;\n      this.store.select(DataQueries.getById('Mission', mission.id)).pipe(switchMap(mission => {\n        return this.downloader.downloadFile(mission.contract).pipe(map(file => ({\n          mission,\n          file\n        })));\n      }), takeUntil(closed$)).subscribe(({\n        mission,\n        file\n      }) => {\n        fileContext = this.downloader.createFileContext(file);\n        const context = {\n          $implicit: {\n            fileContext: fileContext,\n            signedByProfile: mission.signedByCompany && view == 'PME' || mission.signedBySubContractor && view == 'ST',\n            missionId: mission.id,\n            newTask: \"\",\n            view: view\n          }\n        };\n\n        if (first) {\n          this.dimension$.next(this.defaultDimension);\n          this.popups$.next({\n            type: 'predefined',\n            name: 'sign',\n            context,\n            close: () => {\n              this.downloader.clearContext(fileContext);\n              closed$.next();\n            }\n          });\n          first = false;\n        } else {\n          if (previousFileContext) this.downloader.clearContext(previousFileContext);\n          this.updateTemplate(context);\n        }\n\n        previousFileContext = fileContext;\n      });\n    }\n\n    openDateDialog(mission, date, objectSuivi) {\n      const view = this.store.selectSnapshot(DataState.view),\n            closed$ = new Subject();\n      let first = true;\n      const context = {\n        $implicit: {\n          missionId: mission.id,\n          date: date,\n          view: view\n        }\n      };\n\n      if (first) {\n        this.dimension$.next(this.defaultDimension);\n        this.popups$.next({\n          type: 'predefined',\n          name: 'setDate',\n          context,\n          close: () => {\n            closed$.next();\n            let content = document.getElementById(\"addTask\");\n            let contentValue = content.value ? content.value : null;\n            objectSuivi.updatePage(contentValue, mission.id);\n          }\n        });\n        first = false;\n      }\n    }\n\n    openCloseMission(company) {\n      console.log(\"openCloseMission\", company);\n      this.popups$.next({\n        type: 'predefined',\n        name: 'closeMission',\n        context: {\n          $implicit: company\n        }\n      });\n      this.dimension$.next(this.defaultDimension);\n      return new EventEmitter();\n    }\n\n    hide() {\n      this.popups$.next(undefined);\n    }\n\n    updateTemplate(context) {\n      this.popups$.next({\n        type: 'context',\n        context\n      });\n    }\n\n  }\n\n  PopupService.ɵfac = function PopupService_Factory(t) {\n    return new (t || PopupService)(i0.ɵɵinject(i1.Store), i0.ɵɵinject(i5.FileDownloader));\n  };\n\n  PopupService.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n    token: PopupService,\n    factory: PopupService.ɵfac,\n    providedIn: 'root'\n  });\n  return PopupService;\n})();","map":null,"metadata":{},"sourceType":"module"}