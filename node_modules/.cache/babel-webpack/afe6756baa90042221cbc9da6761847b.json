{"ast":null,"code":"import { __decorate } from \"tslib\";\nimport { Select } from \"@ngxs/store\";\nimport { take } from \"rxjs/operators\";\nimport { DataQueries, DataState } from \"src/models/new/data.state\";\nimport { ModifyDetailedPost, CreateSupervision } from \"src/models/new/user/user.actions\";\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@ngxs/store\";\nimport * as i2 from \"src/app/shared/components/popup/popup.component\";\n\nfunction SuiviPME_div_2_h6_5_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"h6\", 17);\n    i0.ɵɵtext(1, \" Signer le contrat \");\n    i0.ɵɵelementEnd();\n  }\n}\n\nfunction SuiviPME_div_2_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r7 = i0.ɵɵgetCurrentView();\n\n    i0.ɵɵelementStart(0, \"div\", 12);\n    i0.ɵɵelementStart(1, \"h6\", 13);\n    i0.ɵɵtext(2, \" Le contrat \");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(3, \"div\", 14);\n    i0.ɵɵlistener(\"click\", function SuiviPME_div_2_Template_div_click_3_listener() {\n      i0.ɵɵrestoreView(_r7);\n      const ctx_r6 = i0.ɵɵnextContext();\n      return ctx_r6.signContract();\n    });\n    i0.ɵɵelement(4, \"file-svg\", 15);\n    i0.ɵɵtemplate(5, SuiviPME_div_2_h6_5_Template, 2, 0, \"h6\", 16);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementEnd();\n  }\n\n  if (rf & 2) {\n    const ctx_r0 = i0.ɵɵnextContext();\n    i0.ɵɵadvance(5);\n    i0.ɵɵproperty(\"ngIf\", ctx_r0.isNotSignedByUser);\n  }\n}\n\nfunction SuiviPME_suivi_chantier_select_date_9_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelement(0, \"suivi-chantier_select_date\");\n  }\n}\n\nfunction SuiviPME_ng_container_10_div_9_div_7_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r15 = i0.ɵɵgetCurrentView();\n\n    i0.ɵɵelementStart(0, \"div\", 34);\n    i0.ɵɵelementStart(1, \"input\", 37);\n    i0.ɵɵlistener(\"focusout\", function SuiviPME_ng_container_10_div_9_div_7_Template_input_focusout_1_listener() {\n      i0.ɵɵrestoreView(_r15);\n      const task_r11 = i0.ɵɵnextContext().$implicit;\n      const ctx_r13 = i0.ɵɵnextContext(2);\n      return ctx_r13.mainComment(task_r11);\n    });\n    i0.ɵɵelementEnd();\n    i0.ɵɵelement(2, \"img\", 36);\n    i0.ɵɵelementEnd();\n  }\n\n  if (rf & 2) {\n    const task_r11 = i0.ɵɵnextContext().$implicit;\n    i0.ɵɵadvance(1);\n    i0.ɵɵpropertyInterpolate1(\"id\", \"input_\", task_r11.id, \"\");\n  }\n}\n\nfunction SuiviPME_ng_container_10_div_9_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r18 = i0.ɵɵgetCurrentView();\n\n    i0.ɵɵelementStart(0, \"div\", 27);\n    i0.ɵɵelementStart(1, \"div\", 28);\n    i0.ɵɵelementStart(2, \"span\", 29);\n    i0.ɵɵtext(3);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(4, \"span\", 30);\n    i0.ɵɵelementStart(5, \"img\", 31);\n    i0.ɵɵlistener(\"click\", function SuiviPME_ng_container_10_div_9_Template_img_click_5_listener() {\n      const restoredCtx = i0.ɵɵrestoreView(_r18);\n      const task_r11 = restoredCtx.$implicit;\n      const ctx_r17 = i0.ɵɵnextContext(2);\n      return ctx_r17.validate(task_r11);\n    });\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(6, \"img\", 31);\n    i0.ɵɵlistener(\"click\", function SuiviPME_ng_container_10_div_9_Template_img_click_6_listener() {\n      const restoredCtx = i0.ɵɵrestoreView(_r18);\n      const task_r11 = restoredCtx.$implicit;\n      const ctx_r19 = i0.ɵɵnextContext(2);\n      return ctx_r19.refuse(task_r11);\n    });\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementEnd();\n    i0.ɵɵtemplate(7, SuiviPME_ng_container_10_div_9_div_7_Template, 3, 1, \"div\", 32);\n    i0.ɵɵelementStart(8, \"div\", 33);\n    i0.ɵɵelementStart(9, \"label\", 21);\n    i0.ɵɵtext(10, \"Communiquer avec votre partenaire de chantier\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementStart(11, \"div\", 34);\n    i0.ɵɵelementStart(12, \"input\", 35);\n    i0.ɵɵlistener(\"focusout\", function SuiviPME_ng_container_10_div_9_Template_input_focusout_12_listener() {\n      i0.ɵɵrestoreView(_r18);\n      const ctx_r20 = i0.ɵɵnextContext(2);\n      return ctx_r20.mainComment(null);\n    });\n    i0.ɵɵelementEnd();\n    i0.ɵɵelement(13, \"img\", 36);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementEnd();\n  }\n\n  if (rf & 2) {\n    const task_r11 = ctx.$implicit;\n    i0.ɵɵadvance(3);\n    i0.ɵɵtextInterpolate1(\" \", task_r11.content, \"\");\n    i0.ɵɵadvance(2);\n    i0.ɵɵpropertyInterpolate1(\"id\", \"control_validate_\", task_r11.id, \"\");\n    i0.ɵɵproperty(\"src\", task_r11.validationImage, i0.ɵɵsanitizeUrl);\n    i0.ɵɵadvance(1);\n    i0.ɵɵpropertyInterpolate1(\"id\", \"control_refuse_\", task_r11.id, \"\");\n    i0.ɵɵproperty(\"src\", task_r11.invalidationImage, i0.ɵɵsanitizeUrl);\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"ngIf\", task_r11.refused);\n  }\n}\n\nfunction SuiviPME_ng_container_10_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r22 = i0.ɵɵgetCurrentView();\n\n    i0.ɵɵelementContainerStart(0);\n    i0.ɵɵelementStart(1, \"accordion\", 18);\n    i0.ɵɵelementStart(2, \"div\", 19);\n    i0.ɵɵelementStart(3, \"div\", 20);\n    i0.ɵɵelementStart(4, \"label\", 21);\n    i0.ɵɵtext(5, \"Choisir les t\\u00E2ches pour ce jour\");\n    i0.ɵɵelementEnd();\n    i0.ɵɵelement(6, \"div\", 22);\n    i0.ɵɵelementStart(7, \"img\", 23);\n    i0.ɵɵlistener(\"click\", function SuiviPME_ng_container_10_Template_img_click_7_listener() {\n      const restoredCtx = i0.ɵɵrestoreView(_r22);\n      const date_r9 = restoredCtx.$implicit;\n      const ctx_r21 = i0.ɵɵnextContext();\n      return ctx_r21.swipemenuModifyAction(date_r9.id);\n    });\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementEnd();\n    i0.ɵɵelement(8, \"div\", 24);\n    i0.ɵɵtemplate(9, SuiviPME_ng_container_10_div_9_Template, 14, 6, \"div\", 25);\n    i0.ɵɵelementEnd();\n    i0.ɵɵelementEnd();\n    i0.ɵɵelement(10, \"hr\", 26);\n    i0.ɵɵelementContainerEnd();\n  }\n\n  if (rf & 2) {\n    const date_r9 = ctx.$implicit;\n    i0.ɵɵadvance(1);\n    i0.ɵɵproperty(\"title\", \"Le \" + date_r9.value);\n    i0.ɵɵadvance(1);\n    i0.ɵɵpropertyInterpolate1(\"id\", \"taskMain_\", date_r9.id, \"\");\n    i0.ɵɵadvance(7);\n    i0.ɵɵproperty(\"ngForOf\", date_r9.selectedTasks);\n  }\n}\n\nfunction SuiviPME_ng_template_27_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelement(0, \"comment\", 38);\n  }\n\n  if (rf & 2) {\n    i0.ɵɵproperty(\"edit\", true);\n  }\n} // export type Task = PostDetail & {validationImage:string, invalidationImage:string}\n// , validationImage:\"assets/suivi-valider.svg\", invalidationImage:\"assets/suivi-refuser.svg\"\n\n\nexport class SuiviPME {\n  constructor(store, popup, cd) {\n    this.store = store;\n    this.popup = popup;\n    this.cd = cd;\n    this.company = null;\n    this.subContractor = null;\n    this.track = {};\n    this.isNotSigned = true;\n    this.isNotSignedByUser = true;\n    this.dates = [];\n    this.currentDateId = null;\n    this.tasks = null;\n    this.companyName = \"\";\n    this.subContractorName = \"\";\n    this.view = \"PME\";\n    this._mission = null;\n    this.swipemenu = false;\n    this.swipemenuModify = false;\n  }\n\n  get mission() {\n    return this._mission;\n  }\n\n  set mission(mission) {\n    console.log(\"setMission\");\n    this.view = this.store.selectSnapshot(DataState.view);\n    this._mission = mission;\n    this.company = mission ? this.store.selectSnapshot(DataQueries.getById('Company', mission.company)) : null;\n    this.subContractor = mission ? this.store.selectSnapshot(DataQueries.getById('Company', mission.subContractor)) : null;\n\n    if (mission) {\n      this.isNotSigned = !(mission.signedByCompany && mission.signedBySubContractor);\n      this.isNotSignedByUser = !mission.signedByCompany && this.view == 'PME' || !mission.signedBySubContractor && this.view == 'ST';\n      this.computeDates(mission);\n      this.companyName = this.subContractor.name;\n      this.subContractorName = this.mission.subContractorName;\n    }\n  }\n\n  computeDates(mission) {\n    this.tasks = this.store.selectSnapshot(DataQueries.getMany('DetailedPost', mission.details)).map(detail => ({\n      id: detail.id,\n      date: detail.date,\n      content: detail.content,\n      validated: detail.validated,\n      refused: detail.refused,\n      supervisions: detail.supervisions,\n      validationImage: this.computeTaskImage(detail, \"validated\"),\n      invalidationImage: this.computeTaskImage(detail, \"refused\")\n    }));\n    this.dates = mission.dates.map((value, id) => ({\n      id: id,\n      value: value,\n      tasks: this.tasks,\n      selectedTasks: this.computeSelectedTask(value)\n    }));\n  }\n\n  computeTaskImage(task, type) {\n    if (type === \"validated\") {\n      if (task.validated && !task.refused) {\n        return \"assets/suivi-valider-OK.svg\";\n      } else {\n        return \"assets/suivi-valider.svg\";\n      }\n    } else {\n      if (!task.validated && task.refused) {\n        return \"assets/suivi-refuser-OK.svg\";\n      } else {\n        return \"assets/suivi-refuser.svg\";\n      }\n    }\n  }\n\n  computeSelectedTask(date) {\n    let selectedTask = [];\n    this.tasks.forEach(task => this.computeSelectedTaskAction(selectedTask, date, task));\n    return selectedTask;\n  }\n\n  computeSelectedTaskAction(selectedTask, date, task) {\n    if (date == task.date) {\n      selectedTask.push(task);\n    }\n  }\n\n  validate(task) {\n    if (this.view == 'ST' && !task.refused) {\n      task.validated = !task.validated;\n      this.store.dispatch(new ModifyDetailedPost(task)).pipe(take(1)).subscribe(() => {\n        this.mission = this.store.selectSnapshot(DataQueries.getById('Mission', this.mission.id));\n        let control = document.getElementById(\"control_validate_\" + task.id);\n        control.src = this.computeTaskImage(task, \"validated\");\n      });\n    }\n  }\n\n  refuse(task) {\n    if (this.view == 'ST' && !task.validated) {\n      task.refused = !task.refused;\n      console.log(\"refuse\", task);\n      this.store.dispatch(new ModifyDetailedPost(task)).pipe(take(1)).subscribe(() => {\n        this.mission = this.store.selectSnapshot(DataQueries.getById('Mission', this.mission.id));\n        let control = document.getElementById(\"control_refuse_\" + task.id);\n        control.src = this.computeTaskImage(task, \"refused\");\n      });\n    }\n  }\n\n  mainComment(task) {\n    if (task) {\n      let input = document.getElementById(\"input_\" + task.id);\n      this.store.dispatch(new CreateSupervision(null, task.id, input.value)).pipe(take(1)).subscribe(() => {});\n      console.log(\"mainComment\", input.value);\n    }\n  }\n\n  signContract() {\n    this.popup.openSignContractDialog(this.mission);\n  }\n\n  addDateToPost() {\n    let date = this.dates[this.currentDateId];\n    this.popup.openDateDialog(this.mission, date, this);\n    this.swipemenuModify = false;\n  }\n\n  updatePage() {\n    let dateId = this.currentDateId;\n    console.log(\"updatePage\", this.mission.id);\n    this.mission = this.store.selectSnapshot(DataQueries.getById('Mission', this.mission.id));\n  }\n\n  swipemenuModifyAction(dateId) {\n    this.swipemenuModify = true;\n    this.currentDateId = dateId;\n    console.log(\"swipemenuModifyAction\", dateId);\n  }\n\n}\n\nSuiviPME.ɵfac = function SuiviPME_Factory(t) {\n  return new (t || SuiviPME)(i0.ɵɵdirectiveInject(i1.Store), i0.ɵɵdirectiveInject(i2.PopupService), i0.ɵɵdirectiveInject(i0.ChangeDetectorRef));\n};\n\nSuiviPME.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n  type: SuiviPME,\n  selectors: [[\"suivi-chantier\"]],\n  inputs: {\n    mission: \"mission\"\n  },\n  decls: 29,\n  vars: 10,\n  consts: [[1, \"container\", \"hosted-page\", \"space-children-margin\"], [3, \"collapsed\", \"application\", \"post\"], [\"class\", \"contrat\", 4, \"ngIf\"], [\"id\", \"test\", 1, \"suivi-notification\", \"flex\", \"column\", 2, \"margin-left\", \"0\"], [1, \"font-Poppins\", 2, \"margin\", \"5px\"], [1, \"full-width\", \"flex\", \"column\"], [4, \"ngFor\", \"ngForOf\"], [1, \"newDate\"], [\"src\", \"assets/plusBlue.svg\"], [3, \"open\", \"openChange\"], [3, \"click\"], [\"comment\", \"\"], [1, \"contrat\"], [1, \"title\", \"font-Poppins\", 2, \"margin-bottom\", \"20px\"], [1, \"flex\", \"center-cross\", \"space-around\", 3, \"click\"], [\"name\", \"Contrat\", \"color\", \"red\"], [\"class\", \"contrat-title font-Poppins\", 4, \"ngIf\"], [1, \"contrat-title\", \"font-Poppins\"], [3, \"title\"], [1, \"form-input\", 3, \"id\"], [1, \"clear-margin\", \"full-width\", \"flex\", \"center-cross\", \"space-arround\"], [2, \"color\", \"#0C5E8D\", \"padding-left\", \"3%\"], [2, \"width\", \"45%\"], [\"src\", \"assets/Option.svg\", 3, \"click\"], [2, \"height\", \"20px\"], [\"class\", \"taskByDate\", \"style\", \"width:97%\", 4, \"ngFor\", \"ngForOf\"], [1, \"dashed\", 2, \"margin-left\", \"0 !important\"], [1, \"taskByDate\", 2, \"width\", \"97%\"], [1, \"details\", \"flex\", \"center-cross\", \"space-between\"], [1, \"detail-name\", 2, \"padding-left\", \"3%\"], [1, \"controls\"], [3, \"id\", \"src\", \"click\"], [\"class\", \"divComment\", 4, \"ngIf\"], [1, \"form-input\"], [1, \"divComment\"], [\"id\", \"input_general}\", \"type\", \"text\", \"placeholder\", \"Ajouter un commentaire\", 1, \"inputComment\", 3, \"focusout\"], [\"src\", \"assets/camera.png\"], [\"type\", \"text\", \"placeholder\", \"Ajouter un commentaire\", 1, \"inputComment\", 3, \"id\", \"focusout\"], [3, \"edit\"]],\n  template: function SuiviPME_Template(rf, ctx) {\n    if (rf & 1) {\n      i0.ɵɵelementStart(0, \"div\", 0);\n      i0.ɵɵelement(1, \"annonce-resume\", 1);\n      i0.ɵɵtemplate(2, SuiviPME_div_2_Template, 6, 1, \"div\", 2);\n      i0.ɵɵelementEnd();\n      i0.ɵɵelementStart(3, \"div\", 3);\n      i0.ɵɵelementStart(4, \"h6\", 4);\n      i0.ɵɵtext(5, \"Suivi du chantier\");\n      i0.ɵɵelementEnd();\n      i0.ɵɵelementStart(6, \"h6\", 4);\n      i0.ɵɵtext(7);\n      i0.ɵɵelementEnd();\n      i0.ɵɵelementEnd();\n      i0.ɵɵelementStart(8, \"div\", 5);\n      i0.ɵɵtemplate(9, SuiviPME_suivi_chantier_select_date_9_Template, 1, 0, \"suivi-chantier_select_date\", 6);\n      i0.ɵɵtemplate(10, SuiviPME_ng_container_10_Template, 11, 3, \"ng-container\", 6);\n      i0.ɵɵelementStart(11, \"div\", 7);\n      i0.ɵɵelement(12, \"img\", 8);\n      i0.ɵɵelementStart(13, \"p\");\n      i0.ɵɵtext(14, \"Ajouter une nouvelle date\");\n      i0.ɵɵelementEnd();\n      i0.ɵɵelementEnd();\n      i0.ɵɵelementEnd();\n      i0.ɵɵelementStart(15, \"swipeup\", 9);\n      i0.ɵɵlistener(\"openChange\", function SuiviPME_Template_swipeup_openChange_15_listener($event) {\n        return ctx.swipemenu = $event;\n      });\n      i0.ɵɵelementStart(16, \"li\");\n      i0.ɵɵtext(17, \"Modifier les horaires de pr\\u00E9sence\");\n      i0.ɵɵelementEnd();\n      i0.ɵɵelementStart(18, \"li\");\n      i0.ɵɵtext(19, \"Appeler le 06 21 94 03 86\");\n      i0.ɵɵelementEnd();\n      i0.ɵɵelementStart(20, \"li\");\n      i0.ɵɵtext(21, \"Cl\\u00F4turer la mission\");\n      i0.ɵɵelementEnd();\n      i0.ɵɵelementStart(22, \"li\");\n      i0.ɵɵtext(23, \"Dupliquer l'annonce\");\n      i0.ɵɵelementEnd();\n      i0.ɵɵelementEnd();\n      i0.ɵɵelementStart(24, \"swipeup\", 9);\n      i0.ɵɵlistener(\"openChange\", function SuiviPME_Template_swipeup_openChange_24_listener($event) {\n        return ctx.swipemenuModify = $event;\n      });\n      i0.ɵɵelementStart(25, \"li\", 10);\n      i0.ɵɵlistener(\"click\", function SuiviPME_Template_li_click_25_listener() {\n        return ctx.addDateToPost();\n      });\n      i0.ɵɵtext(26, \" Modifier les t\\u00E2ches\");\n      i0.ɵɵelementEnd();\n      i0.ɵɵelementEnd();\n      i0.ɵɵtemplate(27, SuiviPME_ng_template_27_Template, 1, 1, \"ng-template\", null, 11, i0.ɵɵtemplateRefExtractor);\n    }\n\n    if (rf & 2) {\n      i0.ɵɵadvance(1);\n      i0.ɵɵproperty(\"collapsed\", true)(\"application\", false)(\"post\", ctx.mission);\n      i0.ɵɵadvance(1);\n      i0.ɵɵproperty(\"ngIf\", ctx.isNotSigned);\n      i0.ɵɵadvance(5);\n      i0.ɵɵtextInterpolate2(\"Avec \", ctx.subContractorName, \" entreprise \", ctx.companyName, \" \");\n      i0.ɵɵadvance(2);\n      i0.ɵɵproperty(\"ngForOf\", ctx.dates);\n      i0.ɵɵadvance(1);\n      i0.ɵɵproperty(\"ngForOf\", ctx.dates);\n      i0.ɵɵadvance(5);\n      i0.ɵɵproperty(\"open\", ctx.swipemenu);\n      i0.ɵɵadvance(9);\n      i0.ɵɵproperty(\"open\", ctx.swipemenuModify);\n    }\n  },\n  styles: [\"[_ngcontent-%COMP%]:root{--notification-size: $notification-size}.page-content-with-tabs[_ngcontent-%COMP%]{width:100%;overflow-y:auto;overflow-x:hidden;touch-action:pan-y!important}.page-content-with-tabs[_ngcontent-%COMP%]{margin-top:150px;margin-top:calc(constant(safe-area-inset-top) + 150px);margin-top:calc(env(safe-area-inset-top) + 150px);margin-bottom:0;margin-bottom:calc(constant(safe-area-inset-bottom) + 0);margin-bottom:calc(env(safe-area-inset-bottom) + 0);height:calc(100vh - 220px - env(safe-area-inset-bottom))}.invert[_ngcontent-%COMP%]{filter:invert(1)}[_nghost-%COMP%]{display:block;width:100%}.annonce[_ngcontent-%COMP%]{background:#FFFFFF!important;color:#000}.dashed[_ngcontent-%COMP%]{margin-left:-30px!important;display:block;width:100vw;border-top:1px dashed black}.contrat-title[_ngcontent-%COMP%]{color:#0d6191;font-size:1rem}.suivi-notification[_ngcontent-%COMP%]{width:100vw;margin-left:-30px;padding-left:30px;color:#fff;height:80px;background-color:#0d6191}.suivi-notification[_ngcontent-%COMP%]   h6[_ngcontent-%COMP%]{font-weight:200;font-size:1em}details[_ngcontent-%COMP%]   summary[_ngcontent-%COMP%]::-webkit-details-marker{display:none!important}.subtitle[_ngcontent-%COMP%]{color:#0d6191}.red[_ngcontent-%COMP%]{filter:invert(24%) sepia(89%) saturate(7468%) hue-rotate(360deg) brightness(104%) contrast(123%)}.green[_ngcontent-%COMP%]{filter:invert(74%) sepia(69%) saturate(5734%) hue-rotate(85deg) brightness(116%) contrast(131%)}.controls[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]:first-child{margin-right:15px}.divComment[_ngcontent-%COMP%]{display:flex;flex-direction:row;border:1px solid #0D6191;border-radius:20px;height:40px;margin:15px;width:96%;padding:10px}.inputComment[_ngcontent-%COMP%]{width:90%}.newDate[_ngcontent-%COMP%]{display:flex;flex-direction:row;justify-content:space-between;width:50%;margin-left:25%;margin-top:30px}.liDate[_ngcontent-%COMP%]{display:flex;flex-direction:row;justify-content:space-around;width:90%}\"],\n  changeDetection: 0\n});\n\n__decorate([Select(DataQueries.currentProfile)], SuiviPME.prototype, \"currentProfile$\", void 0);","map":null,"metadata":{},"sourceType":"module"}